# 两将军问题

@2017.1.19

在研究Paxos协议时看到了与分布式一致性问题有关的两个经典问题：两将军问题和拜占庭将军问题。为了把问题弄清楚，特地把维基百科上的关于这两个问题的词条从头到尾过了一遍，这篇笔记和上一篇[共识](https://lafengnan.gitbooks.io/blog/content/distributed-system/chapter1.html)类似，基本上是维基百科词条的翻译，作为理解问题过程的记录。



在计算机学科中，**两将军问题**是一个[思想实验](https://en.wikipedia.org/wiki/Thought_experiment)，用于揭示在一个不可靠的链接上通过通信来协调统一的行动所面临的设计挑战和缺陷。“两将军问题”与更加通用的[拜占庭将军](https://en.wikipedia.org/wiki/Byzantine_Generals)问题有关（虽然它比后者发表的时间要早得多），尽管“两将军问题”适用于所有两方参与者的可能出现失败的通信系统中，但是通常在关于[计算机网络](https://en.wikipedia.org/wiki/Computer_networking)的入门课程中出现（特别是在[传输控制协议](https://en.wikipedia.org/wiki/Transmission_Control_Protocol)中说明TCP为什么无法保证不同节点之间状态的一致性及其原因）。在[认识逻辑](https://en.wikipedia.org/wiki/Epistemic_logic)中，一个重要的原则是问题强调了[共识](https://lafengnan.gitbooks.io/blog/content/distributed-system/chapter1.html)的重要性。有些作者也将其称为**两将军悖论**、**两军问题**或者**协同攻击问题**。**两将军问题**是第一个被证实的计算机通信无解问题，该证明的一个重要结论是类似于**拜占庭将军问题**的问题在面临无法预知的通信错误时都是无法解决的，从而为分布式一致性协议提供了切实可行的预测基础。

## 定义

有两支军队分别由不同的将军率领，准备攻打一座带有防御工事的城市。军队驻扎在城市附近的两个不同的山谷中，这两座山被第三个山谷从中间一分为二。两位将军之间唯一的通信方式是派遣信使穿过中间的山谷。但不幸的是，中间的山谷被城市的守军占领了，并且所有穿过该山谷信使都可能被抓获。

![两将军问题](/resources/two-generals.png)

​                                                                                             军队位置  

A1军与A2军需要互相通信，但是他们的信使可能会被B军抓获。

两位将军在达成一致肯定会发动进攻时，尚未对进攻时间统一意见。为了稳操胜券，需要两个将军指挥他们的军队同时对这座城市发起进攻，否则单独进攻的军队就是自取灭亡。因此两位将军必须互相通信以决定进攻时间，并且同意在那个时间进攻。 每位将军都**必须**知道另一位将军知道两人对作战计划已经达成一致。由于[消息接收方的应答](https://en.wikipedia.org/wiki/Acknowledgement_(data_networks))和原始消息一样可能很容易就丢失，这里隐藏了这样一个事实：需要无限的消息序列来达成[一致](https://en.wikipedia.org/wiki/Consensus_(computer_science))。

这个思想实验包括他们如何才能达成一致的过程。"两将军问题"最简单的形式中，有一位将军是Leader身份，他来决定进攻的时间，并且必须将这个时间传达给另一位将军。这个问题引出将军可以使用的算法，包括：发送消息和处理回执消息，从而使他们可以正确的得到如下结论：

> 是的，我们两支军队将在协商好的时间同时发起进攻。

允许这样的话，那么将军们对进攻时间达成一致就非常简单了（比如，一条带有成功的回执的消息）。"两将军问题"的精妙之处就在于无法为将军们设计出可以安全使用的可以达成上述协议的算法。



## 问题演示

第一个将军可能发送一条消息"在8月4日早晨 9点发起进攻"。但是，消息一旦发出，第一个将军就无法知道信使是否通过了敌军山谷。这种不确定性可能导致第一个将军由于担心自己成为单一攻击者的风险而对进攻犹豫不决。

如果确认消息送达，第二个将军可能向第一个将军发送一条确认消息："我收到了你的消息，并且将在8月4日早晨9点发起进攻"。但是，携带确认消息的信使可能会被敌军抓获，这样第二个将军也会犹豫，因为他知道第一个将军可能因为没有收到确认信息而中止进攻。

进一步的确认消息看上去像是一个解决方案，让第一个将军向第二个将军发送一个二次确认消息："我已经收到你对在8月4日早晨9点发起进攻的确认回执了"。但是，第一位将军派遣的新信使也可能被敌军抓获。因此，我们很快就可以得出结论，无论发起多少轮的消息确认，也无法保证第二个必要条件成立：每个将军都确认对方已经同意了进攻计划。

两个将军总是处于等待其最后一条消息是否通过敌军山谷的焦虑中。

## 证明

### 具有固定消息数量的确定性协议

因为协议是[确定性](https://en.wikipedia.org/wiki/Deterministic_system)的，假设有一个固定数量的消息序列，其中有一条或者多条消息成功送达，也有一条或者多条消息未能成功送达。假设是，两位将军之间必须有一个*共享的两军都会发起进攻的决议*。

考虑最后一条成功投递的消息。如果最后一条消息未能成功投递，那么至少有一位将军（很可能是接收者）将会决定不发起进攻。从最后一条消息的发送方视角来看，不管怎样，发送和投递消息的顺序与其该有的顺序完全相同，说明那条消息已经投递出去了。

由于协议是确定性的，发送最后一条消息的将军仍然会发起进攻。我们现在已经创建了一种情况，推荐的协议导致一个将军发起进攻而另一个将军却中止进攻，这就与假定该协议可以解决这个问题自相矛盾了。

### 非确定性变长协议

一个带有变化的消息数量的非确定性协议可以比拟成一个"有限树"，树中的每个叶子或者分支（节点）代表截止某个点为止已经发现的示例。

树的根用初始消息标识，从这些根节点衍生的分支节点用初始消息的下一条消息标识。叶子节点代表发送最后一条消息之后的示例。在发送任何消息之前就终止的消息用一棵无效的(null)树表示。

假设存在一个可以解决问题的**非确定协议**，那么与前面章节描述的确定性示例的争论相似，通过移除树中所有叶子节点后得到确定性的示例，那么该确定性示例可以解决这个问题。

由于非确定协议是有限的，一棵空(Empty)树表示的协议可以解决问题，很明显这是不可能的。因此也不存在可以解决"两将军问题"的非确定性协议。

## 工程实践

处理”两将军问题“的可编程方式应该使用这样的模式：*接受通信信道的不确定性，不试图消除这种不确定性。同时，应该将不确定性降到到可接受的程度*。比如，第一个将军可以派出100个信使，期望这100人全部被抓的概率很低。基于这种方式第一个将军无论如何都将发起进攻，而第二个将军只要收到消息也会发起进攻。替代方案是第一个将军可以发送一个消息流，第二个将军可以对其收到的消息流逐个发送确认消息。每收到一条消息将军们的信心都会增加。正如证明中看到的，没人可以确认进攻肯定可以被协调好。不存在他们可以使用的算法（例如，如果收到4条以上的消息就发起进攻）保证不出现只有一方发起进攻的情况。当然，第一位将军可以在每条消息上增加一个标识，表示这条消息的次序1，2，3…..n。这个方法可以让第二个将军知道信道的可靠性，然后回复一定数量的消息，确保接收者有很高的概率可以接收到至少一条消息。如果信道被认为是足够可靠的，那么一条消息就足够了，多余的消息也于事无补。最后一条消息很可能像第一条消息一样丢失。

假设每当派出的信使被截获时，将军们都必须派遣一名新的信使。可以设计一个算法用最少的信使就可以保证获得协调进攻所需的足够高的信心。为了减少完成协调进攻时牺牲的信使人数，将军们可以同意将信使的消失作为发起消息的将军至少已经接收到了一条回执的标志，并且保证会发动进攻。假设一个信使通过危险区域需要花费1分钟，在收到回执后允许200分钟的静默期，可以使我们无需派遣更多的信使就能得到很高的信心。这种情况下，信使仅在一方未接收到进攻时间时使用。当200分钟静默期结束时，每个将军都可以推断：我已经有200分钟没有接收到新消息了，要么是这期间的200个信使都没能闯过危险区，要么意味着对方已经确认并保证会发起进攻，那么我需要这样做。”

## 历史

两将军问题及其无解的证明首次出现在由E.A.Akkoyunlu,K.Ekannadham,和R.V.Huber于1975年发表的论文“网络通信设计中的一些限制与妥协”^2^中，在关于两组匪徒通信的上下文环境中从第73页开始描述。

 这个问题被JimGray在1978年发表的“数据库操作系统比较”^3^第465页中命名为“两将军悖论”。这也是被广泛引用的关于这个问题的定义和误解证明的来源，虽然发表时间并不是最早的。



## 附录

1. [Wikipedia Tow generals]([https://en.wikipedia.org/wiki/Two_Generals%27_Problem](https://en.wikipedia.org/wiki/Two_Generals%27_Problem))
2. ["Some constraints and trade-offs in the design of network communications"](http://hydra.infosys.tuwien.ac.at/teaching/courses/AdvancedDistributedSystems/download/1975_Akkoyunlu,%20Ekanadham,%20Huber_Some%20constraints%20and%20tradeoffs%20in%20the%20design%20of%20network%20communications.pdf)
3. ["Notes on Data Base Operating Systems"](http://portal.acm.org/citation.cfm?coll=GUIDE&dl=GUIDE&id=723863)