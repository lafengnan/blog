# 营销系统

## 背景

业务上线之后运营部门需要根据业务需求开展推广活动，而营销系统的引入会造成后端系统原有业务逻辑的变更。根据运营部门的前期需求，我们整理出了下列几种优惠券资源：

* 虚拟理财本金（新手体验金）
* 优惠券
  - 加息券
  - 加金券
* 点币(积分)

其中积分系统在二期才设计上线，详情请参见[积分系统]()

![coupon](/resources/coupon.png)

## 系统设计

优惠券系统的设计高度依赖运营团队的运营计划，经过与运营团队的沟通，系统设计为营销系统的一个子集，而营销系统又包括以下几个主要部分：

* 营销计划（营销活动）
* 营销资源（优惠券、积分、实物商品、抽奖）
* 营销规则

其中，营销规则在不同的控制粒度下依附于营销资源和营销计划。事实上在营销系统二期设计时，已经将各类抽奖活动、推广活动和积分活动全部纳入统一的活动资源管理之中了。营销规则的重点在于如何区分不同级别的用户（投资金额为主要区分度）可以参与营销活动以及可以访问营销资源的资格问题，主要根据以下几个方面划分：

- 目标客户
  - 客户类型
    - 级别
    - 组别
  - 客户入口来源
    - APP客户端
    - 浏览器客户端
- 目标产品
- 生效条件
  - 金额条件
  - 时间条件
  - 区域条件
- 多资源使用条件
  - 排他
  - 并存（相当于折上折）
  - 择优（系统自动选择最高金额）
  - 优先级排他（优先级最高的K项可用）

其中的多资源使用条件在I期系统中**仅提供排他规则**。

### 管理审核

运营部门推出新的营销计划时需要将设计的营销资源提交到MIS系统中，由相应的职责人员按照审核要求进行审核。营销资源在审核过程中可能处于以下任何一种状态之中：

- 未提交
- 待审核
- 已通过
- 已拒绝

审核状态机如下图所示：

![audit-state-machine](/resources/audit-state-machine.png)



营销资源的生命期：

![coupon-lifecycle](/resources/coupon-lifecycle.png)



只有审核通过且在有效期内的营销资源方可被用户使用。

资源审核通过后，默认直接分发给用户。



### 线上业务

当用户收到优惠券、体验金、加金券、加息券等等营销资源之后，在该资源的有效期内只要满足该资源的使用条件，用户即可以使用资源获取优惠。因此，对于用户来说资源也具备状态，这些状态与后台

管理用户看到的状态不尽相同：

- 未使用
- 已使用
- 已失效

![coupon-user-state](/resources/coupon-user-state.png)

## 业务资源

### 虚拟理财本金

虚拟理财本金只有“新手体验金”这一种优惠资源。

新手体验金仅供新注册用户体验点理财APP使用，其特点是：

- 固定期限：自用户注册之日起28天内（1个月）
- 本金不可提现
- 固定收益率，每周派息一次

### 加息券

加息券指用户在购买平台提供的理财产品时，平台以贴息形式给用户提供优惠。。

加息券的基本特征如下：

- 目标客户为大中额度资产用户
- 针对不同的产品提供不同类型的加息券，不同的加息券区别主要体现在贴息比例
- 固定期限，每张加息券都具有时效性
- 使用方式仅限于购买特定或者指定的理财产品
- 赠送方式：I期通过系统派发，II+期可能加入积分兑换机制等其他派送形式

### 加金券

加金券指用户在购买平台提供的理财产品时，平台以贴本金的形式为用户提供优惠。加金券的基本特征如下：

- 目标客户为小额资产用户
- 加金券以用户实际本金为基础，按照一定比例提供虚拟本金贴补
- 加金券提供的虚拟本金不可提现
- 加金券提供的虚拟本金不抵扣实际募集总额
- 加金券提供的虚拟本金以人民币等额面值的形式计累加入用户实际委托金额计息，即假设用户实际本金为$$RM$$，加金券加金比例为$$n\%$$，则其计息本金金额$$TM = (1 + n\%) \times RM$$
- 用户可提现收益$$RI = TM * 年化收益率 * 持有天数 / 年化天数$$

### 积分

参见[积分系统]()

## 业务逻辑

### 资源编号

优惠资源（加息券、加金券、体验金）等分发给不同的用户时需要生成唯一的编号用以识别不同的优惠资源。

#### MIS系统逻辑

#### 创建资源

MIS系统主要负责营销计划和营销资源的创建、修改、审核、查询、分发和导出等功能。下图为营销资源的创建流程，除新增的MIS-Coupon以外还涉及MIS-Product、MIS-Account两个sub-service。

![create-coupon](/resources/create-coupon.png)

#### 审核资源

营销资源创建之后需要相关运营人员以及管理人员审核，并触发分发机制，将资源分发给营销对象。下图为营销资源的审核与分发流程（I期分发流程内置于审核流程之中，即审核完成之后自动触发分发机制）。

![coupon-mgt-audit](/resources/coupon-mgt-audit.png)

#### 分发资源

由于分发资源需要向账户表中写入大量的数据，为了减少对线上业务的影响，分发资源设计为异步任务。分发流程如下所示：

![coupon-issue](/resources/coupon-issue.png)

其中，SVP表示外部服务供应商，比如短信网关供应商。

蓝色lifecycle表示Producer，品红色lifecycle表示Consumer；蓝色箭头线表示添加/消费异步任务。

优惠券分发过程可能需要记录分发日志，考虑引入Redis利用队列分发。在实际分发优惠券时，在队列中依次将优惠券编码出队，异步写入用户数据表，同时记入日志表中。

##### 新手体验金

新手体验金的分发比较特殊，是在用户注册时自动分配到用户的账号中的，因此与上述分发稍有区别。

![coupon-newbie](/resources/coupon-newbie.png)



#### 使用资源

用户在投资满足一定条件时可以使用优惠券加息或者增加本金。

![coupon-use](/resources/coupon-use.png)



